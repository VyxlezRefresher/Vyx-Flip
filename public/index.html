<script>
// Auto-detect WebSocket URL for localhost or Render
let WS_URL;

// If on localhost, use local WebSocket
if (window.location.hostname === "localhost") {
    WS_URL = "ws://localhost:3000";
} else {
    // Use the same host as the page for WebSocket (works for Render)
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    WS_URL = `${protocol}://${window.location.host}`;
}

const ws = new WebSocket(WS_URL);
let username;
let rotation = 0;

// LOGIN FUNCTION
function login() {
    username = document.getElementById("username").value.trim();
    if (!username) return alert("Enter username");
    ws.send(JSON.stringify({ type: "login", username }));
}

// HANDLE INCOMING MESSAGES
ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "loginSuccess") {
        document.getElementById("loginModal").style.display = "none";
        document.getElementById("balance").textContent = data.balance;
    }

    if (data.type === "queueUpdate") {
        const q = document.getElementById("queue");
        q.innerHTML = "";
        data.queue.forEach(u => {
            const li = document.createElement("li");
            li.textContent = u.username + " (" + u.bet + ")";
            q.appendChild(li);
        });
    }

    if (data.type === "coinflipResult") {
        document.getElementById("coinflipResult").textContent = data.result;
        document.getElementById("balance").textContent = data.newBalance;
        rotation += 1800 + (data.result === "Loser" ? 180 : 0);
        document.getElementById("coin").style.transform = `rotateY(${rotation}deg)`;
    }

    if (data.type === "chat") {
        const chat = document.getElementById("chatMessages");
        const div = document.createElement("div");
        div.className = "chat-message";
        div.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
};

// JOIN COINFLIP
function joinCoinflip() {
    const bet = parseInt(prompt("Enter bet amount")) || 0;
    if (bet <= 0) return;
    ws.send(JSON.stringify({ type: "joinCoinflip", betAmount: bet }));
}

// SEND CHAT
function sendChat() {
    const msg = document.getElementById("chatInput").value.trim();
    if (!msg) return;
    ws.send(JSON.stringify({ type: "chat", message: msg }));
    document.getElementById("chatInput").value = "";
}
</script>
  display: flex;
  flex-direction: column;
}
.chat-message {
  background: rgba(30,30,40,0.9);
  padding: 5px;
  border-radius: 5px;
}
</style>
</head>
<body>

<div class="background-dot" style="left:10%; top:90%; animation-delay:0s;"></div>
<div class="background-dot" style="left:50%; top:100%; animation-delay:5s;"></div>
<div class="background-dot" style="left:80%; top:95%; animation-delay:10s;"></div>
<div class="background-dot" style="left:30%; top:85%; animation-delay:15s;"></div>
<div class="background-dot" style="left:70%; top:80%; animation-delay:20s;"></div>

<div id="loginModal">
  <div>
    <h2>Login / Verify Roblox</h2>
    <input type="text" id="username" placeholder="Roblox Username">
    <button onclick="login()">Login</button>
  </div>
</div>

<div class="sidebar">
  <h3>Balance: <span id="balance">0</span></h3>
  <button onclick="joinCoinflip()">Join Coinflip</button>
  <h4>Queue:</h4>
  <ul id="queue"></ul>
</div>

<div class="main">
  <div class="coinflip-card">
    <div class="coin-container">
      <div class="coin" id="coin">
        <div class="side heads">H</div>
        <div class="side tails">T</div>
      </div>
    </div>
    <h3 id="coinflipResult"></h3>
  </div>
</div>

<div class="chat">
  <div class="chat-messages" id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Message">
  <button onclick="sendChat()">Send</button>
</div>

<script>
const WS_URL = window.location.hostname === "localhost"
  ? "ws://localhost:3000"
  : "wss://https://vyxflip.onrender.com"; // replace YOUR-RENDER-URL with Render URL

const ws = new WebSocket(WS_URL);
let username;
let rotation = 0;

function login() {
  username = document.getElementById("username").value.trim();
  if(!username) return alert("Enter username");
  ws.send(JSON.stringify({ type: "login", username }));
}

ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  if(data.type==="loginSuccess"){
    document.getElementById("loginModal").style.display="none";
    document.getElementById("balance").textContent = data.balance;
  }
  if(data.type==="queueUpdate"){
    const q = document.getElementById("queue"); q.innerHTML="";
    data.queue.forEach(u=>{
      const li = document.createElement("li");
      li.textContent = u.username + " ("+u.bet+")"; q.appendChild(li);
    });
  }
  if(data.type==="coinflipResult"){
    document.getElementById("coinflipResult").textContent = data.result;
    document.getElementById("balance").textContent = data.newBalance;
    rotation += 1800 + (data.result==="Loser"?180:0);
    document.getElementById("coin").style.transform = `rotateY(${rotation}deg)`;
  }
  if(data.type==="chat"){
    const chat = document.getElementById("chatMessages");
    const div = document.createElement("div"); div.className="chat-message";
    div.innerHTML=`<strong>${data.username}:</strong> ${data.message}`; chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
}

function joinCoinflip(){
  const bet = parseInt(prompt("Enter bet amount"))||0; if(bet<=0) return;
  ws.send(JSON.stringify({ type:"joinCoinflip", betAmount:bet }));
}

function sendChat(){
  const msg = document.getElementById("chatInput").value.trim(); if(!msg) return;
  ws.send(JSON.stringify({ type:"chat", message:msg }));
  document.getElementById("chatInput").value="";
}
</script>

</body>
</html>
